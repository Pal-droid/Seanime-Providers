<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Seanime Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Premium Feel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
      tailwind.config = { 
        darkMode: "class",
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
                colors: {
                    gray: {
                        850: '#1f2937',
                        900: '#111827',
                        950: '#030712', 
                    }
                },
                animation: {
                    'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    'fade-in': 'fadeIn 0.5s ease-out',
                },
                keyframes: {
                    fadeIn: {
                        '0%': { opacity: '0', transform: 'translateY(10px)' },
                        '100%': { opacity: '1', transform: 'translateY(0)' },
                    }
                }
            }
        }
      };
    </script>
    <style>
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* Glass effect utilities */
        .glass-panel {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .glass-card {
            background: rgba(31, 41, 55, 0.4);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            border-color: rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            background: rgba(31, 41, 55, 0.6);
        }

        .tab-active {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            border-color: rgba(59, 130, 246, 0.3);
        }
    </style>
  </head>
  <body class="bg-gray-950 text-gray-200 font-sans antialiased min-h-screen flex flex-col">
    
    <!-- Background ambient glow -->
    <div class="fixed top-0 left-0 w-full h-96 bg-gradient-to-b from-blue-900/10 to-transparent pointer-events-none z-0"></div>

    <!-- Navigation -->
    <nav class="glass-panel sticky top-0 z-50 border-b-0 shadow-lg shadow-black/20">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
          
          <!-- Logo Area -->
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-white">
                  Seanime <span class="text-gray-500 font-normal">Marketplace</span>
                </h1>
            </div>
          </div>

          <!-- Mobile Scrollable Tabs -->
          <div class="flex items-center gap-2 overflow-x-auto no-scrollbar pb-1 md:pb-0 -mx-4 px-4 md:mx-0 md:px-0 mask-linear">
            <button class="tab-btn whitespace-nowrap px-4 py-1.5 text-sm font-medium rounded-full border border-transparent hover:bg-gray-800 transition" data-tab="plugins">Plugins</button>
            <button class="tab-btn whitespace-nowrap px-4 py-1.5 text-sm font-medium rounded-full border border-transparent hover:bg-gray-800 transition" data-tab="online">Online Streams</button>
            <button class="tab-btn whitespace-nowrap px-4 py-1.5 text-sm font-medium rounded-full border border-transparent hover:bg-gray-800 transition" data-tab="manga">Manga</button>
            <button class="tab-btn whitespace-nowrap px-4 py-1.5 text-sm font-medium rounded-full border border-transparent hover:bg-gray-800 transition" data-tab="torrent">Torrents</button>
            <button class="tab-btn whitespace-nowrap px-4 py-1.5 text-sm font-medium rounded-full border border-transparent hover:bg-gray-800 transition" data-tab="styling">Styling</button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Search & Filters -->
    <div class="relative z-10 border-b border-gray-800/50 bg-gray-950/50 backdrop-blur-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 py-6">
        <div class="relative group">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-gray-500 group-focus-within:text-blue-400 transition-colors" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            <input
              id="search"
              type="search"
              placeholder="Search plugins, authors, tags..."
              class="w-full pl-11 pr-4 py-3 rounded-xl bg-gray-900/50 border border-gray-800 text-gray-200 placeholder-gray-500 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 focus:bg-gray-900 outline-none transition-all shadow-inner"
            />
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto p-4 sm:p-6 w-full relative z-10">
      
      <!-- Sections -->
      <section id="plugins" class="tab-content grid gap-4 sm:gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></section>
      <section id="online" class="tab-content hidden grid gap-4 sm:gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></section>
      <section id="manga" class="tab-content hidden grid gap-4 sm:gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></section>
      <section id="torrent" class="tab-content hidden grid gap-4 sm:gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></section>

      <!-- Styling Section -->
      <section id="styling" class="tab-content hidden space-y-6">
        <div id="styling-container" class="grid gap-4 sm:gap-6 grid-cols-1 lg:grid-cols-2"></div>
        <div id="styling-empty" class="text-center py-12 text-gray-500">
             <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
             Loading themes...
        </div>
      </section>
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 right-6 bg-gray-900 border border-gray-700 text-white px-4 py-3 rounded-lg shadow-2xl transform translate-y-24 transition-transform duration-300 flex items-center gap-3 z-[60]">
        <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        <span id="toast-msg" class="text-sm font-medium">Operation successful</span>
    </div>

    <!-- Code Snippet Modal -->
    <div id="snippet-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden items-center justify-center z-[70] p-4 sm:p-6 transition-opacity opacity-0">
      <div class="bg-gray-900 rounded-2xl border border-gray-700 shadow-2xl max-w-4xl w-full h-[85vh] flex flex-col overflow-hidden transform scale-95 transition-transform duration-200" id="modal-content">
        <div class="flex justify-between items-center px-6 py-4 border-b border-gray-800 bg-gray-950">
          <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full bg-red-500/20 border border-red-500/50"></span>
              <span class="w-3 h-3 rounded-full bg-yellow-500/20 border border-yellow-500/50"></span>
              <span class="w-3 h-3 rounded-full bg-green-500/20 border border-green-500/50"></span>
              <h3 class="ml-3 text-sm font-mono text-gray-400">css_preview.css</h3>
          </div>
          <div class="flex items-center gap-3">
            <button id="modal-copy" class="flex items-center gap-2 px-3 py-1.5 text-xs font-medium rounded bg-gray-800 hover:bg-gray-700 text-gray-300 border border-gray-700 transition">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                Copy Code
            </button>
            <button id="modal-close" class="text-gray-500 hover:text-white transition p-1">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
          </div>
        </div>

        <div class="flex-1 overflow-auto p-6 bg-[#0d1117]">
          <pre class="font-mono text-xs sm:text-sm leading-relaxed text-gray-300"><code id="modal-code" class="language-css"></code></pre>
        </div>
      </div>
    </div>

    <!-- Templates -->
    
    <!-- 1. Loading Skeleton -->
    <template id="skeleton-template">
        <div class="glass-card rounded-xl p-5 flex flex-col h-full animate-pulse">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 rounded-lg bg-gray-800"></div>
                <div class="ml-3 flex-1 space-y-2">
                    <div class="h-4 bg-gray-800 rounded w-3/4"></div>
                    <div class="h-3 bg-gray-800 rounded w-1/2"></div>
                </div>
            </div>
            <div class="space-y-2 flex-grow">
                <div class="h-3 bg-gray-800 rounded w-full"></div>
                <div class="h-3 bg-gray-800 rounded w-5/6"></div>
            </div>
            <div class="mt-5 flex gap-2">
                <div class="h-8 w-20 bg-gray-800 rounded-lg"></div>
            </div>
        </div>
    </template>

    <!-- 2. Plugin Card -->
    <template id="card-template">
      <div class="glass-card rounded-xl p-5 flex flex-col h-full group animate-fade-in">
        <div class="flex items-start justify-between mb-4">
            <div class="flex items-center">
                <img class="w-12 h-12 rounded-xl bg-gray-800 border border-gray-700 object-cover shadow-sm" loading="lazy" onerror="this.onerror=null;this.src=placeholderDataUrl" />
                <div class="ml-3">
                    <h2 class="text-base font-bold leading-tight text-gray-100 group-hover:text-blue-400 transition-colors"></h2>
                    <p class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        <span class="author-text"></span>
                    </p>
                </div>
            </div>
        </div>
        
        <p class="text-sm text-gray-400 leading-relaxed flex-grow desc-text line-clamp-3"></p>
        
        <div class="mt-5 flex flex-wrap items-center gap-2 pt-4 border-t border-gray-800/50 buttons-container">
            <!-- Buttons injected here -->
        </div>
      </div>
    </template>

    <!-- 3. Snippet Card -->
    <template id="snippet-template">
      <div class="glass-card rounded-xl overflow-hidden group animate-fade-in border-l-4 border-l-blue-500/50">
        <div class="p-4 bg-gray-900/30 flex items-center justify-between border-b border-gray-800">
            <div>
                <h3 class="font-semibold text-sm text-gray-200"></h3>
                <p class="text-[10px] text-gray-500 mt-0.5 font-mono opacity-70 snippet-file"></p>
            </div>
            <div class="flex items-center gap-1">
                <button class="eye-btn p-2 text-gray-400 hover:text-blue-400 hover:bg-blue-500/10 rounded-lg transition" title="Preview">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                </button>
                <button class="copy-btn p-2 text-gray-400 hover:text-green-400 hover:bg-green-500/10 rounded-lg transition" title="Copy">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="bg-[#0d1117] p-4 overflow-x-auto">
             <pre class="text-xs text-gray-400 font-mono"><code class="snippet-code"></code></pre>
        </div>
      </div>
    </template>

    <script>
      // --- Utilities ---
      const placeholderDataUrl = "data:image/svg+xml;utf8," + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'><rect width='100' height='100' fill='#1f2937'/><path d='M50 40 L50 60 M40 50 L60 50' stroke='#374151' stroke-width='2'/></svg>`);
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));
      
      // Safe Clipboard Copy
      function copyToClipboard(text) {
          const textArea = document.createElement("textarea");
          textArea.value = text;
          textArea.style.position = "fixed"; // Avoid scrolling to bottom
          textArea.style.left = "-9999px";
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          try {
            document.execCommand('copy');
            showToast("Copied to clipboard!");
          } catch (err) {
            showToast("Failed to copy", true);
            console.error('Fallback: Oops, unable to copy', err);
          }
          document.body.removeChild(textArea);
      }

      function showToast(msg, isError = false) {
          const toast = document.getElementById('toast');
          const msgEl = document.getElementById('toast-msg');
          const icon = toast.querySelector('svg');
          
          msgEl.textContent = msg;
          toast.classList.remove('translate-y-24');
          
          if(isError) {
              icon.classList.remove('text-green-400');
              icon.classList.add('text-red-400');
              icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
          } else {
              icon.classList.remove('text-red-400');
              icon.classList.add('text-green-400');
              icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';
          }

          setTimeout(() => {
              toast.classList.add('translate-y-24');
          }, 3000);
      }

      // --- Logic ---

      function setActiveTab(id) {
        // Button Styles
        $$(".tab-btn").forEach((b) => {
            b.classList.remove("tab-active", "text-blue-400", "shadow-sm");
            b.classList.add("text-gray-400", "hover:text-gray-200");
        });
        const activeBtn = $$(".tab-btn").find((b) => b.dataset.tab === id);
        if (activeBtn) {
            activeBtn.classList.add("tab-active", "shadow-sm");
            activeBtn.classList.remove("text-gray-400", "hover:text-gray-200");
        }

        // Content Visibility
        $$(".tab-content").forEach((el) => el.classList.add("hidden"));
        const content = document.getElementById(id);
        content.classList.remove("hidden");
        content.classList.add("animate-fade-in");
      }

      function renderSkeletons(containerId, count = 6) {
          const container = document.getElementById(containerId);
          container.innerHTML = "";
          const tpl = document.getElementById("skeleton-template");
          for(let i=0; i<count; i++) {
              container.appendChild(tpl.content.cloneNode(true));
          }
      }

      function normalizePluginData(data) {
        if (!data) return [];
        if (Array.isArray(data)) return data;
        // Try to find array in object values
        const arrCandidates = Object.values(data).filter(
          (v) => Array.isArray(v) && v.length && typeof v[0] === "object"
        );
        if (arrCandidates.length) return arrCandidates.flat();
        // Try to find objects in object values
        const objValues = Object.values(data).filter(
          (v) => v && typeof v === "object" && !Array.isArray(v)
        );
        if (objValues.length) return objValues;
        return [];
      }

      async function loadPlugins() {
        const categories = ["plugins", "online", "manga", "torrent"];
        
        // Show skeletons first
        categories.forEach(id => renderSkeletons(id));

        const url = "https://raw.githubusercontent.com/pal-droid/seanime-providers/main/marketplace/main.json";
        let res, data;

        try {
          res = await fetch(url);
          if (!res.ok) throw new Error("Failed to fetch main.json");
          data = await res.json();
        } catch (e) {
          console.error("Error loading plugins:", e);
          categories.forEach(id => {
              document.getElementById(id).innerHTML = `
                <div class="col-span-full text-center py-12">
                    <p class="text-red-400 bg-red-500/10 px-4 py-2 rounded-lg inline-block">Failed to load marketplace data.</p>
                </div>`;
          });
          return;
        }

        // Clear skeletons
        categories.forEach(id => document.getElementById(id).innerHTML = "");

        const items = normalizePluginData(data);
        
        // If no items
        if (!items.length) {
             categories.forEach(id => {
              document.getElementById(id).innerHTML = `<div class="col-span-full text-center text-gray-500 py-10">No items found.</div>`;
          });
          return;
        }

        const tpl = document.getElementById("card-template");
        const containers = {
          plugin: document.getElementById("plugins"),
          "onlinestream-provider": document.getElementById("online"),
          "manga-provider": document.getElementById("manga"),
          "anime-torrent-provider": document.getElementById("torrent"),
        };

        items.forEach((item) => {
          if (!item || typeof item !== "object") return;
          const type = item.type || "";
          const target = containers[type];
          if (!target) return;

          const node = tpl.content.cloneNode(true);
          const img = node.querySelector("img");
          const title = node.querySelector("h2");
          const authorEl = node.querySelector(".author-text");
          const desc = node.querySelector(".desc-text");
          const btns = node.querySelector(".buttons-container");

          img.src = item.icon || placeholderDataUrl;
          title.textContent = item.name || item.id || "Unnamed";
          authorEl.textContent = item.author || "Unknown";
          desc.textContent = item.description || "No description available.";
          
          btns.innerHTML = "";

          // Website Button
          if (item.website) {
            const a = document.createElement("a");
            a.href = item.website;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.className = "px-3 py-1.5 text-xs font-medium text-blue-400 bg-blue-500/10 border border-blue-500/20 rounded-lg hover:bg-blue-500/20 transition flex items-center gap-1";
            a.innerHTML = `<span>Website</span> <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>`;
            btns.appendChild(a);
          }

          // Install Button
          if (item.manifestURI) {
            const btn = document.createElement("button");
            btn.className = "px-4 py-1.5 text-xs font-medium text-white bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 rounded-lg transition shadow-lg shadow-blue-500/20 flex items-center gap-1 ml-auto";
            btn.textContent = "Install";

            btn.addEventListener("click", async () => {
              btn.disabled = true;
              const originalText = btn.textContent;
              btn.innerHTML = `<svg class="animate-spin h-3 w-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing`;

              try {
                const res = await fetch(
                  "http://localhost:43211/api/v1/extensions/external/install",
                  {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ manifestUri: item.manifestURI }),
                  }
                );

                let result = {};
                try { result = await res.json(); } catch {}

                if (res.ok && (result.success ?? true)) {
                  btn.className = "px-4 py-1.5 text-xs font-medium text-green-400 bg-green-500/10 border border-green-500/20 rounded-lg transition ml-auto";
                  btn.innerHTML = `Installed`;
                } else {
                  throw new Error("Install failed");
                }
              } catch (err) {
                console.error(err);
                btn.textContent = "Failed";
                btn.classList.add("bg-red-500");
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                    btn.classList.remove("bg-red-500");
                }, 2000);
              }
            });

            btns.appendChild(btn);
          }

          target.appendChild(node);
        });
      }

      function applySearch(term) {
        const q = term.trim().toLowerCase();
        const cards = document.querySelectorAll(".tab-content > div");
        let found = false;

        cards.forEach((card) => {
          if (!card) return;
          // Skip skeleton loaders from search
          if(card.querySelector('.animate-pulse')) return;

          const text = card.innerText.toLowerCase();
          if (q === "" || text.includes(q)) {
              card.style.display = "";
              found = true;
          } else {
              card.style.display = "none";
          }
        });
      }

      async function loadSnippets() {
        const container = document.getElementById("styling-container");
        const empty = document.getElementById("styling-empty");
        
        let res;
        try {
          res = await fetch("styles/snippets.json");
          if (!res.ok) throw new Error("no snippets.json");
        } catch {
          empty.innerHTML = `<div class="p-4 bg-gray-900 rounded-lg border border-gray-800 text-sm">Snippets not found. Make sure <code class="text-blue-400">marketplace/styles/snippets.json</code> exists.</div>`;
          return;
        }

        let data;
        try {
          data = await res.json();
        } catch {
          empty.textContent = "Invalid JSON.";
          return;
        }

        let snippets = [];
        if (Array.isArray(data)) snippets = data;
        else if (Array.isArray(data.snippets)) snippets = data.snippets;
        else snippets = Object.values(data).filter((v) => v && (v.file || v.path));

        if (!snippets.length) {
          empty.textContent = "No snippets listed.";
          return;
        }

        empty.style.display = 'none'; // Hide loading
        const tpl = document.getElementById("snippet-template");

        await Promise.all(
          snippets.map(async (s, idx) => {
            const item = typeof s === "string" ? { name: s, file: s } : s;
            const file = item.file || item.path;
            const name = item.name || file || `snippet-${idx + 1}`;

            const node = tpl.content.cloneNode(true);
            node.querySelector("h3").textContent = name;
            node.querySelector(".snippet-file").textContent = file;

            const codeEl = node.querySelector(".snippet-code");
            const copyBtn = node.querySelector(".copy-btn");
            const eyeBtn = node.querySelector(".eye-btn");

            try {
              const r = await fetch(file);
              if (!r.ok) throw new Error("not found");
              const txt = await r.text();
              codeEl.textContent = txt.trim();
            } catch {
              codeEl.textContent = "/* failed to load file: " + file + " */";
            }

            copyBtn.addEventListener("click", () => copyToClipboard(codeEl.textContent));

            eyeBtn.addEventListener("click", () => {
              $("#modal-code").textContent = codeEl.textContent;
              const modal = $("#snippet-modal");
              modal.classList.remove("hidden");
              // Small delay to allow display:flex to apply before opacity transition
              requestAnimationFrame(() => {
                  modal.classList.remove("opacity-0");
                  modal.querySelector('#modal-content').classList.remove("scale-95");
                  modal.querySelector('#modal-content').classList.add("scale-100");
              });
              
            });

            container.appendChild(node);
          })
        );
      }

      // --- Initialization ---

      window.addEventListener("DOMContentLoaded", () => {
        // Tabs
        $$(".tab-btn").forEach((btn) =>
          btn.addEventListener("click", () => setActiveTab(btn.dataset.tab))
        );
        setActiveTab("manga");

        // Search
        let t;
        $("#search").addEventListener("input", (e) => {
          clearTimeout(t);
          t = setTimeout(() => applySearch(e.target.value), 120);
        });

        // Modal logic
        const modal = $("#snippet-modal");
        const closeModal = () => {
            modal.classList.add("opacity-0");
            modal.querySelector('#modal-content').classList.remove("scale-100");
            modal.querySelector('#modal-content').classList.add("scale-95");
            setTimeout(() => modal.classList.add("hidden"), 200);
        };

        $("#modal-close").addEventListener("click", closeModal);
        $("#modal-copy").addEventListener("click", () => copyToClipboard($("#modal-code").textContent));
        
        modal.addEventListener("click", (e) => {
          if (e.target === modal) closeModal();
        });
        
        // Close on Escape
        document.addEventListener('keydown', (e) => {
            if(e.key === "Escape" && !modal.classList.contains('hidden')) {
                closeModal();
            }
        });

        loadPlugins();
        loadSnippets();
      });
    </script>
  </body>
</html>

